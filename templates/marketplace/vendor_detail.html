{% extends 'base.html' %}

{% load static %}
{% block content %}

<!-- Main Section Start -->
<div class="main-section">
    <div class="page-section restaurant-detail-image-section" style="background: url({% if vendor.user_profile.cover_photo %} {{ vendor.user_profile.cover_photo.url }} {% else %} {% static 'images/default-cover.png' %} {% endif %}) no-repeat scroll 0 0 / cover;">
        <!-- Container Start -->
        <div class="container">
            <!-- Row Start -->
            <div class="row">
                <!-- Column Start -->
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <div class="company-info-detail">
                        <div class="company-info">
                            <div class="img-holder">
                                <figure>
                                    {% if vendor.user_profile.profile_picture %}
                                    <img src="{{ vendor.user_profile.profile_picture.url }}" alt="">
                                    {% else %}
                                    <img src="{% static 'images/default-profile.png' %}" alt="">
                                    {% endif %}
                                </figure>
                            </div>
                            <div class="text-holder">
                                <span class="restaurant-title">{{ vendor.vendor_name }} {% if not vendor.is_open %}[Closed]{% endif %}</span>
                                <div class="text">
                                    {% if vendor.user_profile.address %}
                                    <i class="icon-location"></i>
                                    <p>{{vendor.user_profile.address}}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% if opening_hours %}
                        <div class="delivery-timing reviews-sortby">
                            
                            <ul>
                                <li>
                                    <a href="#" class="reviews-sortby-active">
                                        <span>Today :</span>
                                        {% for i in current_opening_hours %}
                                        <span>{% if i.is_closed %}Closed{% else %}{{ i.from_hour }} - {{ i.to_hour }}{% endif %}</span>
                                        
                                        {% endfor %}
                                        <i class="icon-chevron-small-down"></i>
                                    </a>
                                    <ul class="delivery-dropdown">
                                        {% for hour in opening_hours %}
                                        <li><a href="#"><span class="opend-day">{{ hour }}</span> <span class="opend-time"><small>:</small>{% if hour.is_closed %}Closed{% else %}{{ hour.from_hour }} - {{ hour.to_hour }}{% endif %}</span></a></li>
                                        {% endfor %}
                                    </ul>
                                </li>
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <!-- Column End -->
            </div>
            <!-- Row End -->
        </div>
        <!-- Container End -->
    </div>

    <div class="page-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-3 col-md-3 col-sm-4 col-xs-12 sticky-sidebar">
                    
                    <div class="filter-wrapper">
                        <div class="categories-menu">
                            <h6><i class="icon-restaurant_menu"></i>Categories</h6>
                            <ul class="menu-list" id="category-nav">
                                {% for category in categories %}
                                <li><a href="#category-{{ category.id }}" class="menu-category-link" data-target="category-{{ category.id }}"> {{ category }} </a></li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-lg-9 col-md-9 col-sm-8 col-xs-12">
                    <div class="tabs-holder horizontal">
                        <ul class="stickynav-tabs nav nav-tabs">
                            <li class="active"><a data-bs-toggle="tab" href="#home"><i class="icon- icon-room_service"></i>Menu</a></li>
                            
                        </ul>
                        <div class="tab-content">
                            <div id="home" class="tab-pane in active">
                                <div class="menu-itam-holder">
                                    
                                    <div id="menu-item-list-6272" class="menu-itam-list">
                                        
                                        {% for category in categories %}
                                        <div class="element-title menu-category-section" id="category-{{ category.id }}">
                                            <h5 class="text-color">{{ category }}</h5>
                                            <span>{{ category.description }}</span>
                                        </div>
                                        <ul>
                                            {% for food in category.fooditems.all %}
                                            <li id="food-item-{{ food.id }}" style="flex-wrap:wrap;">
                                                <div class="image-holder">
                                                    {% if food.image %}
                                                    <img src="{{ food.image.url }}" alt="{{ food.food_title }}">
                                                    {% else %}
                                                    <img src="{% static 'images/default-food.png' %}" alt="{{ food.food_title }}">
                                                    {% endif %}
                                                </div>
                                                <div class="text-holder">
                                                    <h6>{{ food }}</h6>
                                                    <span>{{ food.description }}</span>
                                                    <!-- Similar toggle link -->
                                                    <a href="#" class="similar-toggle-link" data-food-id="{{ food.id }}"
                                                       style="display:inline-flex;align-items:center;gap:4px;font-size:11px;color:#e23744;margin-top:4px;text-decoration:none;">
                                                        <i class="fa-solid fa-wand-magic-sparkles" style="font-size:10px;"></i>
                                                        <span class="similar-toggle-text">See similar items</span>
                                                        <i class="fa-solid fa-chevron-down similar-chevron" style="font-size:9px;transition:transform .2s;"></i>
                                                    </a>
                                                </div>
                                                <div class="price-holder">
                                                    <span class="price">${{ food.price }}</span>

                                                    <a href="#" class="decrease_cart" data-id="{{ food.id }}" data-url="{% url 'decrease_cart' food.id %}" style="margin-right: 28px;"><i class="icon-minus text-color"></i></a>
                                                    <label id="qty-{{food.id}}">0</label>
                                                    <a href="#" class="add_to_cart" data-id="{{ food.id }}" data-url="{% url 'add_to_cart' food.id %}"><i class="icon-plus4 text-color"></i></a>
                                                </div>

                                                <!-- Similar Items Panel (inline, full-width under this item) -->
                                                <div class="similar-panel" id="similar-panel-{{ food.id }}"
                                                     style="display:none;width:100%;padding:12px 0 4px;border-top:1px dashed #f0f0f0;margin-top:8px;">
                                                    <p style="font-size:12px;color:#888;margin-bottom:8px;">
                                                        <i class="fa-solid fa-wand-magic-sparkles me-1" style="color:#e23744;"></i>
                                                        <strong style="color:#333;">You might also like</strong>
                                                        <span style="font-size:10px;color:#aaa;margin-left:6px;">— similar items from this menu</span>
                                                    </p>
                                                    <div class="similar-items-row d-flex flex-wrap gap-2" id="similar-items-{{ food.id }}">
                                                        <span class="similar-loading" style="font-size:12px;color:#aaa;">
                                                            <i class="fa-solid fa-circle-notch fa-spin me-1"></i> Loading...
                                                        </span>
                                                    </div>
                                                </div>
                                            </li>
                                            {% endfor %}

                                        </ul>
                                        {% endfor %}
                                        
                                    </div>

                                    {% for item in cart_items %}

                                    <span id="qty-{{item.fooditem.id}}" class="item_qty d-none" data-qty="{{ item.quantity }}">{{ item.quantity }}</span>

                                    

                                    {% endfor %}
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
</div>
<!-- Main Section End -->

{% endblock %}

{% block js %}
<script>
(function () {
    const cache = {};

    // Current vendor slug from URL: /marketplace/<slug>/
    const currentVendorSlug = window.location.pathname.split('/').filter(Boolean).pop();

    function renderStars(rating) {
        let html = '';
        for (let i = 1; i <= 5; i++) {
            html += i <= Math.round(rating)
                ? '<i class="fa fa-star" style="color:#f5a623;font-size:10px;"></i>'
                : '<i class="fa fa-star-o" style="color:#ccc;font-size:10px;"></i>';
        }
        return html;
    }

    function buildCard(item) {
        const isSameVendor = item.vendor_slug === currentVendorSlug;
        const img = item.image
            ? `<img src="${item.image}" alt="${item.title}" style="width:100%;height:70px;object-fit:cover;border-radius:6px 6px 0 0;">`
            : `<img src="/static/images/default-food.png" alt="${item.title}" style="width:100%;height:70px;object-fit:cover;border-radius:6px 6px 0 0;">`;
        const stars = item.avg_rating ? `<div style="margin-top:2px;">${renderStars(item.avg_rating)}</div>` : '';

        // Same vendor → scroll to item on this page; different → navigate to their page
        const action = isSameVendor
            ? `onclick="scrollToItem(${item.id}); return false;" href="#food-item-${item.id}"`
            : `href="/marketplace/${item.vendor_slug}/"`;

        const addBtn = `
          <button onclick="event.preventDefault(); event.stopPropagation(); quickAdd(${item.id});"
                  style="width:100%;margin-top:4px;padding:3px 0;font-size:10px;font-weight:600;
                         background:#e23744;color:#fff;border:none;border-radius:4px;cursor:pointer;">
              + Add to Cart
          </button>`;

        return `
        <a ${action} style="text-decoration:none;color:inherit;">
          <div style="width:120px;border:1px solid #f0f0f0;border-radius:8px;overflow:hidden;
                      box-shadow:0 1px 4px rgba(0,0,0,0.08);background:#fff;flex-shrink:0;">
            ${img}
            <div style="padding:6px;">
              <p style="font-size:11px;font-weight:600;margin:0;line-height:1.3;">${item.title}</p>
              <p style="font-size:10px;color:#888;margin:1px 0;">${item.vendor}</p>
              <p style="font-size:11px;color:#e23744;font-weight:700;margin:2px 0;">$${item.price}</p>
              ${stars}
              ${addBtn}
            </div>
          </div>
        </a>`;
    }

    // Scroll to the food item on the same page and flash highlight it
    window.scrollToItem = function (foodId) {
        const el = document.getElementById(`food-item-${foodId}`);
        if (!el) return;
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.style.transition = 'background 0.3s';
        el.style.background = '#fff8e1';
        setTimeout(() => { el.style.background = ''; }, 1800);
    };

    // Quick add to cart using the existing cart endpoint
    window.quickAdd = function (foodId) {
        const url = `/marketplace/add_to_cart/${foodId}/`;
        fetch(url, {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'login_required') {
                window.location.href = '/login/';
                return;
            }
            if (data.qty !== undefined) {
                // Update the qty label on the main menu list
                const qtyLabel = document.getElementById(`qty-${foodId}`);
                if (qtyLabel) qtyLabel.textContent = data.qty;
                // Update cart counter in navbar if present
                const counter = document.getElementById('cart_counter');
                if (counter && data.cart_counter) counter.textContent = data.cart_counter['cart_count'];
                // Brief green flash on the Add button
                const btns = document.querySelectorAll(`button[onclick*="quickAdd(${foodId})"]`);
                btns.forEach(b => {
                    b.textContent = '✓ Added';
                    b.style.background = '#28a745';
                    setTimeout(() => { b.textContent = '+ Add to Cart'; b.style.background = '#e23744'; }, 1200);
                });
            }
        })
        .catch(() => {});
    };

    function showPanel(foodId) {
        const panel = document.getElementById(`similar-panel-${foodId}`);
        const row   = document.getElementById(`similar-items-${foodId}`);
        const link  = document.querySelector(`.similar-toggle-link[data-food-id="${foodId}"]`);
        const text  = link ? link.querySelector('.similar-toggle-text') : null;
        const chev  = link ? link.querySelector('.similar-chevron') : null;

        const isOpen = panel.style.display !== 'none';
        if (isOpen) {
            panel.style.display = 'none';
            if (text) text.textContent = 'See similar items';
            if (chev) chev.style.transform = '';
            return;
        }

        panel.style.display = 'block';
        if (text) text.textContent = 'Hide similar';
        if (chev) chev.style.transform = 'rotate(180deg)';

        if (cache[foodId]) { renderItems(row, cache[foodId]); return; }

        fetch(`/recommendations/similar-items/${foodId}/`)
            .then(r => r.json())
            .then(data => { cache[foodId] = data.items; renderItems(row, data.items); })
            .catch(() => {
                row.innerHTML = '<span style="font-size:12px;color:#aaa;">Could not load similar items.</span>';
            });
    }

    function renderItems(row, items) {
        if (!items || items.length === 0) {
            row.innerHTML = '<span style="font-size:12px;color:#aaa;">No similar items found.</span>';
            return;
        }
        row.innerHTML = items.map(buildCard).join('');
    }

    document.addEventListener('click', function (e) {
        const trigger = e.target.closest('.similar-toggle-link');
        if (!trigger) return;
        e.preventDefault();
        const foodId = trigger.dataset.foodId;
        if (foodId) showPanel(foodId);
    });

    // ── Category sidebar navigation ──────────────────────────────────────
    const catLinks = document.querySelectorAll('.menu-category-link');
    const catSections = document.querySelectorAll('.menu-category-section');

    function setActiveLink(targetId) {
        catLinks.forEach(l => l.parentElement.classList.remove('active'));
        const active = document.querySelector(`.menu-category-link[data-target="${targetId}"]`);
        if (active) active.parentElement.classList.add('active');
    }

    catLinks.forEach(link => {
        link.addEventListener('click', function (e) {
            e.preventDefault();
            const targetId = this.dataset.target;
            const section = document.getElementById(targetId);
            if (!section) return;
            const offset = 80; // account for sticky header
            const top = section.getBoundingClientRect().top + window.scrollY - offset;
            window.scrollTo({ top, behavior: 'smooth' });
            setActiveLink(targetId);
        });
    });

    // Highlight sidebar link as user scrolls through categories
    const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                setActiveLink(entry.target.id);
            }
        });
    }, { rootMargin: '-30% 0px -60% 0px' });

    catSections.forEach(s => observer.observe(s));
    // ─────────────────────────────────────────────────────────────────────
})();
</script>
{% endblock %}