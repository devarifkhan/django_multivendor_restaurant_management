{% extends 'base.html' %}

{% load static %}
{% block content %}

<!-- Main Section Start -->
<div class="main-section">
    <div class="page-section restaurant-detail-image-section" style="background: url({% if vendor.user_profile.cover_photo %} {{ vendor.user_profile.cover_photo.url }} {% else %} {% static 'images/default-cover.png' %} {% endif %}) no-repeat scroll 0 0 / cover;">
        <!-- Container Start -->
        <div class="container">
            <!-- Row Start -->
            <div class="row">
                <!-- Column Start -->
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <div class="company-info-detail">
                        <div class="company-info">
                            <div class="img-holder">
                                <figure>
                                    {% if vendor.user_profile.profile_picture %}
                                    <img src="{{ vendor.user_profile.profile_picture.url }}" alt="">
                                    {% else %}
                                    <img src="{% static 'images/default-profile.png' %}" alt="">
                                    {% endif %}
                                </figure>
                            </div>
                            <div class="text-holder">
                                <span class="restaurant-title">{{ vendor.vendor_name }} {% if not vendor.is_open %}[Closed]{% endif %}</span>
                                <div class="text">
                                    {% if vendor.user_profile.address %}
                                    <i class="icon-location"></i>
                                    <p>{{vendor.user_profile.address}}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% if opening_hours %}
                        <div class="delivery-timing reviews-sortby">
                            
                            <ul>
                                <li>
                                    <a href="#" class="reviews-sortby-active">
                                        <span>Today :</span>
                                        {% for i in current_opening_hours %}
                                        <span>{% if i.is_closed %}Closed{% else %}{{ i.from_hour }} - {{ i.to_hour }}{% endif %}</span>
                                        
                                        {% endfor %}
                                        <i class="icon-chevron-small-down"></i>
                                    </a>
                                    <ul class="delivery-dropdown">
                                        {% for hour in opening_hours %}
                                        <li><a href="#"><span class="opend-day">{{ hour }}</span> <span class="opend-time"><small>:</small>{% if hour.is_closed %}Closed{% else %}{{ hour.from_hour }} - {{ hour.to_hour }}{% endif %}</span></a></li>
                                        {% endfor %}
                                    </ul>
                                </li>
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <!-- Column End -->
            </div>
            <!-- Row End -->
        </div>
        <!-- Container End -->
    </div>

    <div class="page-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-3 col-md-3 col-sm-4 col-xs-12 sticky-sidebar">
                    
                    <div class="filter-wrapper">
                        <div class="categories-menu">
                            <h6><i class="icon-restaurant_menu"></i>Categories</h6>
                            <ul class="menu-list">
                                {% for category in categories %}
                                <li class="active"><a href="#" class="menu-category-link"> {{ category }} </a></li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-lg-9 col-md-9 col-sm-8 col-xs-12">
                    <div class="tabs-holder horizontal">
                        <ul class="stickynav-tabs nav nav-tabs">
                            <li class="active"><a data-bs-toggle="tab" href="#home"><i class="icon- icon-room_service"></i>Menu</a></li>
                            
                        </ul>
                        <div class="tab-content">
                            <div id="home" class="tab-pane in active">
                                <div class="menu-itam-holder">
                                    
                                    <div id="menu-item-list-6272" class="menu-itam-list">
                                        
                                        {% for category in categories %}
                                        <div class="element-title" id="menu-category-2">
                                            <h5 class="text-color">{{ category }}</h5>
                                            <span>{{ category.description }}</span>
                                        </div>
                                        <ul>
                                            {% for food in category.fooditems.all %}
                                            <li style="flex-wrap:wrap;">
                                                <div class="image-holder similar-trigger" data-food-id="{{ food.id }}" style="cursor:pointer;" title="Click to see similar items">
                                                    {% if food.image %}
                                                    <img src="{{ food.image.url }}" alt="{{ food.food_title }}">
                                                    {% else %}
                                                    <img src="{% static 'images/default-food.png' %}" alt="{{ food.food_title }}">
                                                    {% endif %}
                                                </div>
                                                <div class="text-holder">
                                                    <h6 class="similar-trigger" data-food-id="{{ food.id }}" style="cursor:pointer;">
                                                        {{ food }}
                                                    </h6>
                                                    <span>{{ food.description }}</span>
                                                    <!-- Similar toggle link -->
                                                    <a href="#" class="similar-toggle-link" data-food-id="{{ food.id }}"
                                                       style="display:inline-flex;align-items:center;gap:4px;font-size:11px;color:#e23744;margin-top:4px;text-decoration:none;">
                                                        <i class="fa-solid fa-wand-magic-sparkles" style="font-size:10px;"></i>
                                                        <span class="similar-toggle-text">See similar items</span>
                                                        <i class="fa-solid fa-chevron-down similar-chevron" style="font-size:9px;transition:transform .2s;"></i>
                                                    </a>
                                                </div>
                                                <div class="price-holder">
                                                    <span class="price">${{ food.price }}</span>

                                                    <a href="#" class="decrease_cart" data-id="{{ food.id }}" data-url="{% url 'decrease_cart' food.id %}" style="margin-right: 28px;"><i class="icon-minus text-color"></i></a>
                                                    <label id="qty-{{food.id}}">0</label>
                                                    <a href="#" class="add_to_cart" data-id="{{ food.id }}" data-url="{% url 'add_to_cart' food.id %}"><i class="icon-plus4 text-color"></i></a>
                                                </div>

                                                <!-- Similar Items Panel (inline, full-width under this item) -->
                                                <div class="similar-panel" id="similar-panel-{{ food.id }}"
                                                     style="display:none;width:100%;padding:12px 0 4px;border-top:1px dashed #f0f0f0;margin-top:8px;">
                                                    <p style="font-size:12px;color:#888;margin-bottom:8px;">
                                                        <i class="fa-solid fa-wand-magic-sparkles me-1" style="color:#e23744;"></i>
                                                        <strong style="color:#333;">You might also like</strong>
                                                        <span style="font-size:10px;color:#aaa;margin-left:6px;">— similar items from this menu</span>
                                                    </p>
                                                    <div class="similar-items-row d-flex flex-wrap gap-2" id="similar-items-{{ food.id }}">
                                                        <span class="similar-loading" style="font-size:12px;color:#aaa;">
                                                            <i class="fa-solid fa-circle-notch fa-spin me-1"></i> Loading...
                                                        </span>
                                                    </div>
                                                </div>
                                            </li>
                                            {% endfor %}

                                        </ul>
                                        {% endfor %}
                                        
                                    </div>

                                    {% for item in cart_items %}

                                    <span id="qty-{{item.fooditem.id}}" class="item_qty d-none" data-qty="{{ item.quantity }}">{{ item.quantity }}</span>

                                    

                                    {% endfor %}
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
</div>
<!-- Main Section End -->

{% endblock %}

{% block js %}
<script>
(function () {
    // Cache: food_id → fetched items (avoid repeated AJAX calls)
    const cache = {};

    function renderStars(rating) {
        let html = '';
        for (let i = 1; i <= 5; i++) {
            html += i <= Math.round(rating)
                ? '<i class="fa fa-star" style="color:#f5a623;font-size:10px;"></i>'
                : '<i class="fa fa-star-o" style="color:#ccc;font-size:10px;"></i>';
        }
        return html;
    }

    function buildCard(item) {
        const img = item.image
            ? `<img src="${item.image}" alt="${item.title}" style="width:100%;height:70px;object-fit:cover;border-radius:6px 6px 0 0;">`
            : `<img src="/static/images/default-food.png" alt="${item.title}" style="width:100%;height:70px;object-fit:cover;border-radius:6px 6px 0 0;">`;
        const stars = item.avg_rating ? `<div style="margin-top:2px;">${renderStars(item.avg_rating)}</div>` : '';
        return `
        <a href="/vendor/${item.vendor_slug}/" style="text-decoration:none;color:inherit;">
          <div style="width:120px;border:1px solid #f0f0f0;border-radius:8px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,0.08);background:#fff;flex-shrink:0;">
            ${img}
            <div style="padding:6px;">
              <p style="font-size:11px;font-weight:600;margin:0;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">${item.title}</p>
              <p style="font-size:10px;color:#888;margin:1px 0;">${item.vendor}</p>
              <p style="font-size:11px;color:#e23744;font-weight:700;margin:2px 0;">$${item.price}</p>
              ${stars}
            </div>
          </div>
        </a>`;
    }

    function showPanel(foodId) {
        const panel = document.getElementById(`similar-panel-${foodId}`);
        const row   = document.getElementById(`similar-items-${foodId}`);
        const link  = document.querySelector(`.similar-toggle-link[data-food-id="${foodId}"]`);
        const text  = link ? link.querySelector('.similar-toggle-text') : null;
        const chev  = link ? link.querySelector('.similar-chevron') : null;

        const isOpen = panel.style.display !== 'none';

        if (isOpen) {
            panel.style.display = 'none';
            if (text) text.textContent = 'See similar items';
            if (chev) chev.style.transform = '';
            return;
        }

        panel.style.display = 'block';
        if (text) text.textContent = 'Hide similar';
        if (chev) chev.style.transform = 'rotate(180deg)';

        // Already fetched?
        if (cache[foodId]) {
            renderItems(row, cache[foodId]);
            return;
        }

        // AJAX call
        fetch(`/recommendations/similar-items/${foodId}/`)
            .then(r => r.json())
            .then(data => {
                cache[foodId] = data.items;
                renderItems(row, data.items);
            })
            .catch(() => {
                row.innerHTML = '<span style="font-size:12px;color:#aaa;">Could not load similar items.</span>';
            });
    }

    function renderItems(row, items) {
        if (!items || items.length === 0) {
            row.innerHTML = '<span style="font-size:12px;color:#aaa;">No similar items found.</span>';
            return;
        }
        row.innerHTML = items.map(buildCard).join('');
    }

    // Delegated click — image, title, or the toggle link
    document.addEventListener('click', function (e) {
        const trigger = e.target.closest('.similar-trigger, .similar-toggle-link');
        if (!trigger) return;
        e.preventDefault();
        const foodId = trigger.dataset.foodId;
        if (foodId) showPanel(foodId);
    });
})();
</script>
{% endblock %}